---
layout: post
title: "IPv6 Optimierungen"
author: MAGIC
teaser: "IPv6 Optimierungen"
excerpt: "Seit der Aktivierung öffentlicher IPv6 Adressen für alle Clients hatten wir aufgrund unser Netzstruktur einen ungünstigen Datenfluss bei ein- und ausgehenden IPv6-Verbindungen."
---

Seit der Aktivierung öffentlicher IPv6 Adressen für alle Clients hatten wir aufgrund unser Netzstruktur einen ungünstigen Datenfluss bei ein- und ausgehenden IPv6-Verbindungen.Weil Datenpakete nicht den kürzesten Weg durch unser Netz genommen haben sondern intern weiter verteilt werden mussten hat dies zu einem unnötigen Bandbreitenverbrauch geführt.
Das Verhalten hat uns einiges an Kopfzerbrechen bereitet, letztendlich haben wird aber eine Lösung gefunden, die wir in den letzten Wochen stückweise aktiviert und heute abgeschlossen haben. Nachfolgend noch eine detaillierte Beschreibung des Problems und der von uns gewählten Lösung.

### Das Problem
Unsere Freifunk MWU Netze bestehen aus vielen kleinen Teilnetzen die mittels [B.A.T.M.A.N. Advanced](https://www.open-mesh.org/projects/batman-adv/wiki) zu einem großen virtuellen [Layer 2](https://de.wikipedia.org/wiki/OSI-Modell#Schicht_2_.E2.80.93_Sicherungsschicht_.28Data_Link_Layer.29) Netzwerk zusammengeschaltet werden. Innerhalb dieser Netze kann jedes Gerät direkt mit allen anderen kommunizieren. In jedem dieser Netze gibt es vier Gateways die im wesentlichen drei Aufgaben haben. 1) Sie sind die VPN Gegenstelle für alle Knoten, 2) Default Gateway für alle Clients und 3) kümmern sich und die Ausleitung des Internetverkehrs über den [Freifunk Rheinland](https://www.wiesbaden.freifunk.net/2016/08/24/Public-IPv6-Aktivierung.html). Aufgrund dieser virtuellen Netztopologie wissen die Endgeräte nichts über die wirkliche Struktur des Netzes. Dies war solange kein Problem wie wir extern nur über IPv4 kommuniziert haben, da jedes Gateway eine eindeutige Adresse hatte und sämtlicher Internetverkehr der Clients mit diesen ge[NAT](https://de.wikipedia.org/wiki/Netzwerkadress%C3%BCbersetzung)et wurde. Hierdurch konnte der Freifunk Rheinland immer eindeutig zuordnen über welches Gateway die Verbindung initiert wurde und hat die Daten immer auf dem für uns kürzesten Weg übertragen. Mit IPv6 ist es aber nicht mehr nötig NAT einzusetzen (Nein, NAT ist kein Sicherheitsfeature!) da 2^128 Adressen verfügbar sind, dass sind ca. 600 Billiarden Adressen pro mm². Ohne NAT wird die Adresse bei ausgehendem Datenverkehr nicht mehr durch die des Gateways ersetzt wodurch die Systeme des Freifunk Rheinland nicht mehr zuordnen können über welches Gateway die Anfrage gesendet wurden und senden die Daten an das erstbeste. Unsere Gateways müssen sich dann darum kümmern die Daten intern an das Gateway weiterzuleiten über welches die Daten angefragt wurden. Da diese, wie bereits erwähnt, bei verschiedenen Hostern stehen entsteht ein unnötige Belastung der verfügbaren Bandbreite.

### Die Lösung
Wir haben verschiedene Ansätze diskutiert und kamen am Ende nur zu einer Lösung. Wir müssen unsere Netze (/48) in kleinere [Subnetze](https://de.wikipedia.org/wiki/Subnetz) (/56) segmentieren. Gesagt, getan. Seit ein paar Tagen besitzt jedes Gateway sein eigenes Subnetz. Leider ist dies nur die halbe Lösung da es nur für eingehende Daten hilft. Durch unser Layer 2 Netz erhält jeder Client die [Router Advertisements](https://de.wikipedia.org/wiki/Neighbor_Discovery_Protocol#Router_Advertisement_.E2.80.93_Type_134) (im folgenden kurz RA genannt) von allen Gateways und trägt sich deshalb auch alle vier als Default Gateway ein. Da der Client nicht weiß an welches Gateway der Knoten per VPN verbunden ist kann er keine qualifizierte Entscheidung treffen welches Gateway für ihn das Nächste ist. Glücklicherweise haben sich bereits andere kluge Menschen darüber die Köpfe zerbrochen und ein Programm namens [gluon-radv-filterd](https://github.com/freifunk-gluon/gluon/pull/838) entwickelt. Dieses Programm muss auf den Knoten laufen und ist seit der Version 2016.2.2+mwu1 in unser Firmware enthalten. Die Funktion ist relativ einfach zu verstehen, alles was das Programm tut ist sich jedes eingehende RA Paket anzuschauen und zu prüfen welche Verbindungsqualität (TQ) B.A.T.M.A.N Advanced zu der Gegenstelle hat die dieses gesendet hat. Anschließend wird eine Filterregel erstellt die alle RAs verwirft die nicht von der Gegenstelle mit der besten TQ kommen. Da die TQ mit jedem Hop sinkt können wir sicher sein, dass das RA Paket mit der besten TQ vom nächstgelegen Gateway kommt.